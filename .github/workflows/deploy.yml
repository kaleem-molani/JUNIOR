name: Deploy to Lightsail

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Deploy to environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

jobs:
  test:
    runs-on: ubuntu-latest
    # Run tests on all pushes and PRs, skip only on production workflow_dispatch
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.deploy_target != 'production'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linting
      run: npm run lint
      continue-on-error: true

    - name: Build application
      run: npm run build

    - name: Run mock API tests
      run: npx tsx test/test-api-mock.ts

  deploy:
    runs-on: ubuntu-latest
    # Run on master/main pushes, or manual workflow_dispatch
    if: |
      (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main') ||
      github.event_name == 'workflow_dispatch'
    needs: test
    environment:
      name: ${{ github.event.inputs.deploy_target || 'staging' }}

    steps:
    - name: Deploy to Lightsail
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.LIGHTSAIL_HOST }}
        username: ${{ secrets.LIGHTSAIL_USER }}
        key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
        port: ${{ secrets.LIGHTSAIL_PORT }}
        script: |
          # Set deployment target
          DEPLOY_ENV="${{ github.event.inputs.deploy_target || 'staging' }}"
          echo "üöÄ Deploying to: $DEPLOY_ENV"

          # Navigate to app directory
          cd /home/ubuntu/trading-app

          # Backup current deployment
          echo "üì¶ Creating backup..."
          BACKUP_TIME=$(date +%Y%m%d_%H%M%S)
          if [ -d ".next" ]; then
            cp -r .next .next.backup.$BACKUP_TIME 2>/dev/null || true
            echo "‚úÖ Backup created: .next.backup.$BACKUP_TIME"
          fi

          # Download latest code from GitHub
          echo "üì• Downloading latest code..."
          # Get the current commit SHA
          COMMIT_SHA="${{ github.sha }}"
          echo "üìã Deploying commit: $COMMIT_SHA"
          
          # Check if this is a git repository
          if [ -d ".git" ]; then
            echo "üìã Updating existing git repository..."
            git fetch origin
            git reset --hard $COMMIT_SHA
          else
            echo "üìã Initializing fresh git repository..."
            rm -rf *
            git clone https://github.com/kaleem-molani/JUNIOR.git .
            git checkout $COMMIT_SHA
          fi
          echo "‚úÖ Code updated"

          # Securely create environment file
          echo "üîß Setting up environment variables..."
          cat > .env.production << EOF
          DATABASE_URL=${{ secrets.DATABASE_URL_PRODUCTION }}
          NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL=http://juniorinfo.in/
          NODE_ENV=production
          APP_ENV=production
          SANDBOX_MODE=false
          MOCK_BROKER_API=false
          SKIP_REAL_TRADING=false
          PORT=4000
          EOF

          # Set permissions for env file
          chmod 600 .env.production
          echo "‚úÖ Environment configured"

          # Install dependencies
          echo "üì¶ Installing dependencies..."
          npm ci --production
          echo "‚úÖ Dependencies installed"

          # Generate Prisma client
          echo "ÔøΩÔ∏è Generating Prisma client..."
          npx prisma generate
          echo "‚úÖ Prisma client generated"

          # Build the application
          echo "üî® Building application..."
          npm run build
          echo "‚úÖ Application built"

          # Verify build output
          if [ -d ".next" ]; then
            echo "‚úÖ .next directory exists after build"
            ls -la .next/ | head -5
          else
            echo "‚ùå .next directory NOT found after build"
            exit 1
          fi

          # Run migrations (only on production)
          if [ "$DEPLOY_ENV" = "production" ]; then
              echo "üóÑÔ∏è Running database migrations..."
              npx prisma db push --accept-data-loss
              echo "‚úÖ Migrations completed"
          else
              echo "‚è≠Ô∏è Skipping migrations for $DEPLOY_ENV"
          fi

          # Stop current application
          echo "üõë Stopping current application..."
          pm2 stop trading-app || true
          pm2 delete trading-app || true
          echo "‚úÖ Application stopped"

          # Start new application
          echo "üöÄ Starting application..."
          pm2 start ecosystem.config.js --env $DEPLOY_ENV
          pm2 save
          echo "‚úÖ Application started"

          # Health check
          echo "üîç Running health check..."
          sleep 15
          if curl -f -s http://localhost:4000/api/health > /dev/null; then
            echo "‚úÖ Deployment successful!"
            echo "üåê Application is running at: http://localhost:4000"
          else
            echo "‚ö†Ô∏è Application started but health check failed"
            pm2 logs trading-app --lines 20
            exit 1
          fi

  rollback:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure() && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')

    steps:
    - name: Rollback deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.LIGHTSAIL_HOST }}
        username: ${{ secrets.LIGHTSAIL_USER }}
        key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
        port: ${{ secrets.LIGHTSAIL_PORT }}
        script: |
          cd /home/ubuntu/trading-app
          
          # Find latest backup
          LATEST_BACKUP=$(ls -t .next.backup.* 2>/dev/null | head -1)
          
          if [ -n "$LATEST_BACKUP" ]; then
            echo "üîÑ Rolling back to $LATEST_BACKUP"
            rm -rf .next
            cp -r $LATEST_BACKUP .next
            pm2 start ecosystem.config.js --env production
            echo "‚úÖ Rollback completed"
          else
            echo "‚ùå No backup found for rollback"
          fi