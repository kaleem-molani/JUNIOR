name: Deploy to Lightsail

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Deploy to environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

jobs:
  test:
    runs-on: ubuntu-latest
    # Run tests on all pushes and PRs, skip only on production workflow_dispatch
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.deploy_target != 'production'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linting
      run: npm run lint
      continue-on-error: true

    - name: Build application
      run: npm run build

    - name: Run mock API tests
      run: npx tsx test/test-api-mock.ts

  deploy:
    runs-on: ubuntu-latest
    # Run on master/main pushes, or manual workflow_dispatch
    if: |
      (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main') ||
      github.event_name == 'workflow_dispatch'
    needs: test
    environment: 
      name: ${{ github.event.inputs.deploy_target || 'staging' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build application
      run: npm run build

    - name: Create deployment package
      run: |
        mkdir -p deploy
        cp -r .next deploy/
        cp -r public deploy/ 2>/dev/null || echo "No public directory to copy"
        cp -r prisma deploy/
        cp package*.json deploy/
        cp next.config.js deploy/
        cp tsconfig.json deploy/
        cp ecosystem.config.js deploy/
        cp -r scripts deploy/
        echo "Deployment package created"

    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: deploy-package
        path: deploy/
        retention-days: 1

    - name: Download deployment artifact
      uses: actions/download-artifact@v4
      with:
        name: deploy-package
        path: deploy-downloaded/

    - name: Deploy to Lightsail
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.LIGHTSAIL_HOST }}
        username: ${{ secrets.LIGHTSAIL_USER }}
        key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
        port: ${{ secrets.LIGHTSAIL_PORT }}
        scp: |
          deploy-downloaded/ecosystem.config.js => /tmp/deploy/ecosystem.config.js
          deploy-downloaded/package.json => /tmp/deploy/package.json
          deploy-downloaded/package-lock.json => /tmp/deploy/package-lock.json
          deploy-downloaded/next.config.js => /tmp/deploy/next.config.js
          deploy-downloaded/tsconfig.json => /tmp/deploy/tsconfig.json
          deploy-downloaded/.next => /tmp/deploy/.next
          deploy-downloaded/prisma => /tmp/deploy/prisma
          deploy-downloaded/scripts => /tmp/deploy/scripts
        script: |
          # Set deployment target
          DEPLOY_ENV="${{ github.event.inputs.deploy_target || 'staging' }}"
          echo "üöÄ Deploying to: $DEPLOY_ENV"
          
          # Navigate to app directory
          cd /home/ubuntu/trading-app
          
          # Create backup
          echo "üì¶ Creating backup..."
          BACKUP_TIME=$(date +%Y%m%d_%H%M%S)
          pm2 stop trading-app || true
          cp -r .next .next.backup.$BACKUP_TIME 2>/dev/null || true
          
          # Securely create environment file
          echo "üîß Setting up environment variables..."
          cat > .env.production << EOF
          DATABASE_URL=${{ secrets.DATABASE_URL_PRODUCTION }}
          NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL=http://juniorinfo.in/
          NODE_ENV=production
          APP_ENV=production
          SANDBOX_MODE=false
          MOCK_BROKER_API=false
          SKIP_REAL_TRADING=false
          PORT=4000
          EOF
          
          # Set permissions for env file
          chmod 600 .env.production
          
          # Export environment variables for current session
          export DATABASE_URL="${{ secrets.DATABASE_URL_PRODUCTION }}"
          export NEXTAUTH_SECRET="${{ secrets.NEXTAUTH_SECRET }}"
          export NEXTAUTH_URL="https://yourdomain.com"
          export NODE_ENV="production"
          export APP_ENV="production"
          
          # Verify DATABASE_URL is set (without exposing it)
          if [ -z "$DATABASE_URL" ]; then
              echo "‚ùå DATABASE_URL not set!"
              exit 1
          fi
          
          echo "‚úÖ Database configuration loaded securely"
          
          # Update application
          echo "üì• Updating application..."
          rm -rf .next public prisma scripts ecosystem.config.js
          
          # List files in deployment package for debugging
          echo "üì¶ Files in deployment package:"
          ls -la /tmp/deploy/
          
          # Copy files explicitly
          cp -r /tmp/deploy/.next . 2>/dev/null || echo "No .next directory"
          cp -r /tmp/deploy/public . 2>/dev/null || echo "No public directory"
          cp -r /tmp/deploy/prisma . 2>/dev/null || echo "No prisma directory"
          cp -r /tmp/deploy/scripts . 2>/dev/null || echo "No scripts directory"
          cp /tmp/deploy/package.json . 2>/dev/null || echo "No package.json"
          cp /tmp/deploy/package-lock.json . 2>/dev/null || echo "No package-lock.json"
          cp /tmp/deploy/next.config.js . 2>/dev/null || echo "No next.config.js"
          cp /tmp/deploy/tsconfig.json . 2>/dev/null || echo "No tsconfig.json"
          cp /tmp/deploy/ecosystem.config.js . 2>/dev/null || echo "No ecosystem.config.js"
          
          # Verify ecosystem.config.js exists
          if [ -f "ecosystem.config.js" ]; then
              echo "‚úÖ ecosystem.config.js found"
          else
              echo "‚ùå ecosystem.config.js not found after copy"
              ls -la
              exit 1
          fi
          
          # Make scripts executable
          chmod +x scripts/*.sh
          
          # Install dependencies
          echo "üì¶ Installing dependencies..."
          npm ci --production
          
          # Generate Prisma client
          echo "üóÑÔ∏è Generating Prisma client..."
          npx prisma generate
          
          # Run migrations (only on production)
          if [ "$DEPLOY_ENV" = "production" ]; then
              echo "üóÑÔ∏è Running database migrations..."
              npx prisma db push --accept-data-loss
          else
              echo "‚è≠Ô∏è Skipping migrations for $DEPLOY_ENV"
          fi
          
          # Start application
          echo "üöÄ Starting application..."
          pm2 start ecosystem.config.js --env $DEPLOY_ENV
          
          # Health check
          echo "üîç Running health check..."
          sleep 10
          if curl -f -s http://localhost:4000/api/health > /dev/null; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ö†Ô∏è Application started but health check failed"
          fi

  rollback:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure() && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')

    steps:
    - name: Rollback deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.LIGHTSAIL_HOST }}
        username: ${{ secrets.LIGHTSAIL_USER }}
        key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
        port: ${{ secrets.LIGHTSAIL_PORT }}
        script: |
          cd /home/ubuntu/trading-app
          
          # Find latest backup
          LATEST_BACKUP=$(ls -t .next.backup.* 2>/dev/null | head -1)
          
          if [ -n "$LATEST_BACKUP" ]; then
            echo "üîÑ Rolling back to $LATEST_BACKUP"
            rm -rf .next
            cp -r $LATEST_BACKUP .next
            pm2 start ecosystem.config.js --env production
            echo "‚úÖ Rollback completed"
          else
            echo "‚ùå No backup found for rollback"
          fi