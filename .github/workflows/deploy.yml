name: Deploy to Lightsail

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Deploy to environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

jobs:
  test:
    runs-on: ubuntu-latest
    # Run tests on all pushes and PRs, skip only on production workflow_dispatch
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.deploy_target != 'production'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linting
      run: npm run lint
      continue-on-error: true

    - name: Build application
      run: npm run build

    - name: Start application server
      run: npm run dev &
      env:
        NODE_ENV: test
        DATABASE_URL: "postgresql://test:test@localhost:5432/test_db"
        NEXTAUTH_SECRET: "test-secret-for-ci"
        NEXTAUTH_URL: "http://localhost:4000"

    - name: Wait for server to be ready
      run: |
        timeout 60 bash -c 'until curl -f http://localhost:4000/api/health > /dev/null 2>&1; do sleep 2; done'
      env:
        NODE_ENV: test

    - name: Run API tests
      run: npx tsx test/test-api-endpoints.ts
      env:
        NODE_ENV: test

  deploy:
    runs-on: ubuntu-latest
    # Run on master/main pushes, or manual workflow_dispatch
    if: |
      (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main') ||
      github.event_name == 'workflow_dispatch'
    needs: test
    environment: 
      name: ${{ github.event.inputs.deploy_target || 'staging' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build application
      run: npm run build

    - name: Create deployment package
      run: |
        mkdir -p deploy
        cp -r .next deploy/
        cp -r public deploy/
        cp -r prisma deploy/
        cp package*.json deploy/
        cp next.config.js deploy/
        cp tsconfig.json deploy/
        cp ecosystem.config.js deploy/
        cp -r scripts deploy/
        echo "Deployment package created"

    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: deploy-package
        path: deploy/
        retention-days: 1

    - name: Deploy to Lightsail
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.LIGHTSAIL_HOST }}
        username: ${{ secrets.LIGHTSAIL_USER }}
        key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
        port: ${{ secrets.LIGHTSAIL_PORT }}
        script: |
          # Set deployment target
          DEPLOY_ENV="${{ github.event.inputs.deploy_target || 'staging' }}"
          echo "üöÄ Deploying to: $DEPLOY_ENV"
          
          # Navigate to app directory
          cd /home/ubuntu/trading-app
          
          # Create backup
          echo "üì¶ Creating backup..."
          BACKUP_TIME=$(date +%Y%m%d_%H%M%S)
          pm2 stop trading-app || true
          cp -r .next .next.backup.$BACKUP_TIME 2>/dev/null || true
          
          # Load environment variables
          echo "üîß Loading environment variables..."
          if [ -f ".env.production" ]; then
              export $(cat .env.production | xargs)
              echo "‚úÖ Loaded .env.production"
          elif [ -f ".env" ]; then
              export $(cat .env | xargs)
              echo "‚úÖ Loaded .env"
          else
              echo "‚ö†Ô∏è No environment file found"
          fi
          
          # Verify DATABASE_URL
          if [ -z "$DATABASE_URL" ]; then
              echo "‚ùå DATABASE_URL not set!"
              exit 1
          fi
          
          # Update application
          echo "üì• Updating application..."
          rm -rf .next public prisma scripts ecosystem.config.js
          cp -r /tmp/deploy/* .
          
          # Make scripts executable
          chmod +x scripts/*.sh
          
          # Install dependencies
          echo "üì¶ Installing dependencies..."
          npm ci --production
          
          # Generate Prisma client
          echo "üóÑÔ∏è Generating Prisma client..."
          npx prisma generate
          
          # Run migrations (only on production)
          if [ "$DEPLOY_ENV" = "production" ]; then
              echo "üóÑÔ∏è Running database migrations..."
              npx prisma db push --accept-data-loss
          else
              echo "‚è≠Ô∏è Skipping migrations for $DEPLOY_ENV"
          fi
          
          # Start application
          echo "üöÄ Starting application..."
          pm2 start ecosystem.config.js --env $DEPLOY_ENV
          
          # Health check
          echo "üîç Running health check..."
          sleep 10
          if curl -f -s http://localhost:4000/api/health > /dev/null; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ö†Ô∏è Application started but health check failed"
          fi

    - name: Notify deployment status
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        fields: repo,message,commit,author,action,eventName,ref,workflow
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  rollback:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure() && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')

    steps:
    - name: Rollback deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.LIGHTSAIL_HOST }}
        username: ${{ secrets.LIGHTSAIL_USER }}
        key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
        port: ${{ secrets.LIGHTSAIL_PORT }}
        script: |
          cd /home/ubuntu/trading-app
          
          # Find latest backup
          LATEST_BACKUP=$(ls -t .next.backup.* 2>/dev/null | head -1)
          
          if [ -n "$LATEST_BACKUP" ]; then
            echo "üîÑ Rolling back to $LATEST_BACKUP"
            rm -rf .next
            cp -r $LATEST_BACKUP .next
            pm2 start ecosystem.config.js --env production
            echo "‚úÖ Rollback completed"
          else
            echo "‚ùå No backup found for rollback"
          fi